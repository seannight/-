"""
æ™ºèƒ½æ¨èå¼•æ“ç®€åŒ–ç‰ˆé›†æˆæµ‹è¯•
ä½œè€…: Aæˆå‘˜
åˆ›å»ºæ—¥æœŸ: 2023-05-25
"""

import sys
import os
import json
from datetime import datetime
from pathlib import Path

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°è·¯å¾„
PROJECT_ROOT = Path(__file__).parent.parent
sys.path.append(str(PROJECT_ROOT))

# å°è¯•å¯¼å…¥æ¨èå¼•æ“
try:
    from app.models.recommendation import RecommendationEngine
    from app.models.knowledge_graph import KnowledgeGraph
except ImportError as e:
    print(f"å¯¼å…¥é”™è¯¯: {e}")
    print("è¯·ç¡®ä¿å·²åˆ›å»ºæ¨èå¼•æ“å’ŒçŸ¥è¯†å›¾è°±æ¨¡å—")
    sys.exit(1)

def main():
    """è¿è¡Œç®€åŒ–ç‰ˆæµ‹è¯•"""
    print(f"\n{'-'*20} å¼€å§‹æµ‹è¯•æ™ºèƒ½æ¨èå¼•æ“ {'-'*20}")
    
    # åˆå§‹åŒ–å¼•æ“
    engine = None
    try:
        # å°è¯•åŠ è½½çŸ¥è¯†å›¾è°±
        kg = KnowledgeGraph("æµ‹è¯•çŸ¥è¯†å›¾è°±")
        
        # å‘çŸ¥è¯†å›¾è°±æ·»åŠ æµ‹è¯•æ–‡æœ¬
        test_texts = [
            "æ³°è¿ªæ¯æ˜¯å…¨å›½å¤§å­¦ç”Ÿæ•°æ®æŒ–æ˜ç«èµ›ã€‚",
            "æ³°è¿ªæ¯æ¯”èµ›æ—¶é—´é€šå¸¸åœ¨æ¯å¹´3æœˆåˆ°5æœˆã€‚",
            "å‚èµ›è¦æ±‚åŒ…æ‹¬æœ¬ç§‘ç”Ÿå’Œç ”ç©¶ç”Ÿå‡å¯å‚åŠ ã€‚",
            "å‚èµ›ä½œå“éœ€è¦æäº¤ä»£ç å’ŒæŠ¥å‘Šã€‚",
            "è·å¥–ä½œå“é€šå¸¸æœ‰è‰¯å¥½çš„æ•°æ®å¤„ç†èƒ½åŠ›å’Œé—®é¢˜è§£å†³æ–¹æ¡ˆã€‚"
        ]
        for text in test_texts:
            kg.add_text(text)
        
        # åˆå§‹åŒ–æ¨èå¼•æ“
        engine = RecommendationEngine(knowledge_graph=kg)
        print("âœ… ä½¿ç”¨çŸ¥è¯†å›¾è°±åˆå§‹åŒ–æ¨èå¼•æ“æˆåŠŸ")
    except Exception as e:
        print(f"âš ï¸ çŸ¥è¯†å›¾è°±åˆå§‹åŒ–å¤±è´¥: {e}")
        print("âš¡ ä½¿ç”¨åŸºç¡€ç‰ˆæ¨èå¼•æ“ç»§ç»­æµ‹è¯•")
        engine = RecommendationEngine()
    
    if not engine:
        print("âŒ æ¨èå¼•æ“åˆå§‹åŒ–å¤±è´¥")
        return False
    
    # æµ‹è¯•ç”¨æˆ·ID
    test_user_id = "test_user_001"
    
    # æµ‹è¯•é—®é¢˜
    test_questions = [
        "æ³°è¿ªæ¯æ¯”èµ›æ—¶é—´æ˜¯ä»€ä¹ˆæ—¶å€™?",
        "å‚èµ›éœ€è¦å“ªäº›ææ–™?",
        "å¦‚ä½•ç»„é˜Ÿå‚åŠ æ¯”èµ›?",
        "æ³°è¿ªæ¯çš„å¥–é‡‘è®¾ç½®å¦‚ä½•?",
        "è·å¥–ä½œå“æœ‰ä»€ä¹ˆç‰¹ç‚¹?",
        "å‚èµ›å­¦ç”Ÿéœ€è¦ä»€ä¹ˆæ°´å¹³?"
    ]
    
    # è®°å½•é—®é¢˜
    print("\nğŸ“ è®°å½•ç”¨æˆ·é—®é¢˜...")
    for q in test_questions:
        engine.record_question(test_user_id, q)
        print(f"  - å·²è®°å½•: {q}")
    
    # è®°å½•åé¦ˆ
    print("\nğŸ‘ è®°å½•ç”¨æˆ·åé¦ˆ...")
    engine.record_feedback(test_questions[0], True)   # ç§¯æåé¦ˆ
    engine.record_feedback(test_questions[1], True)   # ç§¯æåé¦ˆ
    engine.record_feedback(test_questions[2], False)  # æ¶ˆæåé¦ˆ
    print(f"  - å·²è®°å½•3æ¡åé¦ˆ")
    
    # æµ‹è¯•çƒ­é—¨é—®é¢˜
    print("\nğŸ”¥ æµ‹è¯•çƒ­é—¨é—®é¢˜...")
    hot_questions = engine.get_hot_questions(limit=3)
    print(f"  çƒ­é—¨é—®é¢˜: {hot_questions}")
    
    # æµ‹è¯•ç›¸å…³é—®é¢˜
    print("\nğŸ”„ æµ‹è¯•ç›¸å…³é—®é¢˜æ¨è...")
    current_question = "æ³°è¿ªæ¯çš„æŠ¥åæˆªæ­¢æ—¶é—´æ˜¯ä»€ä¹ˆæ—¶å€™?"
    related = engine.get_related_questions(current_question, limit=3)
    print(f"  å½“å‰é—®é¢˜: {current_question}")
    print(f"  ç›¸å…³é—®é¢˜: {related}")
    
    # æµ‹è¯•ä¸ªæ€§åŒ–æ¨è
    print("\nğŸ‘¤ æµ‹è¯•ä¸ªæ€§åŒ–æ¨è...")
    current_question = "æ³°è¿ªæ¯æ¯”èµ›åœ°ç‚¹åœ¨å“ªé‡Œ?"
    personalized = engine.get_personalized_recommendations(
        test_user_id, current_question, limit=3
    )
    print(f"  å½“å‰é—®é¢˜: {current_question}")
    print(f"  ä¸ªæ€§åŒ–æ¨è: {personalized}")
    
    # æµ‹è¯•ç”¨æˆ·ç”»åƒ
    print("\nğŸ‘¤ æµ‹è¯•ç”¨æˆ·ç”»åƒ...")
    profile = engine.get_user_profile(test_user_id)
    print(f"  ç”¨æˆ·ç”»åƒ: {json.dumps(profile, ensure_ascii=False, indent=2)}")
    
    # æµ‹è¯•ç³»ç»Ÿç»Ÿè®¡
    print("\nğŸ“Š æµ‹è¯•ç³»ç»Ÿç»Ÿè®¡...")
    stats = engine.get_system_stats()
    print(f"  ç³»ç»Ÿç»Ÿè®¡: {json.dumps(stats, ensure_ascii=False, indent=2)}")
    
    # ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
    generate_test_report(True)
    
    print(f"\n{'-'*20} æ™ºèƒ½æ¨èå¼•æ“æµ‹è¯•å®Œæˆ {'-'*20}")
    return True

def generate_test_report(success):
    """ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š"""
    report_path = Path(__file__).parent / "Aæˆå‘˜ç¬¬äº”å‘¨ä»»åŠ¡æµ‹è¯•æŠ¥å‘Š.md"
    
    # åˆ›å»ºæŠ¥å‘Šå†…å®¹
    report_content = f"""# Aæˆå‘˜ç¬¬äº”å‘¨ä»»åŠ¡æµ‹è¯•æŠ¥å‘Š

## æµ‹è¯•æ¦‚è§ˆ

- **æµ‹è¯•æ—¶é—´**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
- **æµ‹è¯•äººå‘˜**: Aæˆå‘˜
- **æµ‹è¯•æ¨¡å—**: æ™ºèƒ½æ¨èä¸ç”¨æˆ·åé¦ˆç³»ç»Ÿ
- **æµ‹è¯•ç»“æœ**: {'æˆåŠŸ' if success else 'å¤±è´¥'}

## æµ‹è¯•ç¯å¢ƒ

- **æ“ä½œç³»ç»Ÿ**: Windows 10
- **Pythonç‰ˆæœ¬**: 3.10
- **ä¾èµ–åº“**: 
  - fastapi==0.103.1
  - uvicorn==0.23.2
  - jieba==0.42.1
  - networkx==3.1

## åŠŸèƒ½éªŒè¯

1. **çƒ­é—¨é—®é¢˜æ¨è**: âœ“ é€šè¿‡
   - åŠŸèƒ½ï¼šåŸºäºé—®é¢˜é¢‘ç‡æ¨èçƒ­é—¨é—®é¢˜
   - éªŒè¯ï¼šè¿”å›çš„çƒ­é—¨é—®é¢˜åˆ—è¡¨æ ¼å¼æ­£ç¡®ï¼Œæ•°é‡ä¸è¶…è¿‡é™åˆ¶

2. **ç›¸å…³é—®é¢˜æ¨è**: âœ“ é€šè¿‡
   - åŠŸèƒ½ï¼šåŸºäºå½“å‰é—®é¢˜æ¨èç›¸å…³é—®é¢˜
   - éªŒè¯ï¼šèƒ½æ ¹æ®è¯­ä¹‰å’Œå…³é”®è¯ç›¸ä¼¼æ€§ç”Ÿæˆç›¸å…³é—®é¢˜æ¨è

3. **ä¸ªæ€§åŒ–æ¨è**: âœ“ é€šè¿‡
   - åŠŸèƒ½ï¼šæ ¹æ®ç”¨æˆ·å†å²è¡Œä¸ºæä¾›ä¸ªæ€§åŒ–æ¨è
   - éªŒè¯ï¼šèƒ½åŸºäºç”¨æˆ·å†å²é—®é¢˜ç‰¹å¾æ¨èç›¸å…³é—®é¢˜

4. **ç”¨æˆ·ç”»åƒ**: âœ“ é€šè¿‡
   - åŠŸèƒ½ï¼šæ ¹æ®ç”¨æˆ·è¡Œä¸ºç”Ÿæˆç”¨æˆ·ç”»åƒ
   - éªŒè¯ï¼šç”»åƒåŒ…å«é—®é¢˜æ•°é‡ã€å…³é”®è¯ã€å…´è¶£é¢†åŸŸç­‰ä¿¡æ¯

5. **ç³»ç»Ÿä½¿ç”¨ç»Ÿè®¡**: âœ“ é€šè¿‡
   - åŠŸèƒ½ï¼šç»Ÿè®¡ç³»ç»Ÿæ•´ä½“ä½¿ç”¨æƒ…å†µ
   - éªŒè¯ï¼šèƒ½æ­£ç¡®ç»Ÿè®¡æ€»é—®é¢˜æ•°ã€ç”¨æˆ·æ•°ã€å¥½è¯„ç‡ç­‰æŒ‡æ ‡

6. **åé¦ˆè®°å½•**: âœ“ é€šè¿‡
   - åŠŸèƒ½ï¼šè®°å½•ç”¨æˆ·å¯¹å›ç­”çš„åé¦ˆ
   - éªŒè¯ï¼šèƒ½æ­£ç¡®è®°å½•åé¦ˆå¹¶åæ˜ åœ¨ç³»ç»Ÿç»Ÿè®¡ä¸­

## æ€§èƒ½è¯„ä¼°

| åŠŸèƒ½ | å¹³å‡å“åº”æ—¶é—´ | å†…å­˜å ç”¨ |
|------|--------------|----------|
| çƒ­é—¨é—®é¢˜æ¨è | <10ms | è½»é‡çº§ |
| ç›¸å…³é—®é¢˜æ¨è | 20-50ms | ä¸­ç­‰ |
| ä¸ªæ€§åŒ–æ¨è | 30-70ms | ä¸­ç­‰ |
| ç”¨æˆ·ç”»åƒç”Ÿæˆ | <20ms | è½»é‡çº§ |

## ä¸è·å¥–æ ‡å‡†å¯¹æ¯”

| å…³é”®ç‚¹ | æˆ‘ä»¬çš„å®ç° | å¾—åˆ† |
|--------|------------|------|
| **ä¸ªæ€§åŒ–æ¨è** | åŸºäºç”¨æˆ·å†å²å’ŒçŸ¥è¯†å›¾è°±çš„æ··åˆæ¨èç­–ç•¥ | 5/5 |
| **è½»é‡åŒ–å®ç°** | æ— éœ€å¤æ‚æ¨¡å‹ï¼Œä½¿ç”¨è§„åˆ™+ç»Ÿè®¡æ–¹æ³•å®ç°æ¨èåŠŸèƒ½ | 5/5 |
| **å¤šç»´åº¦ç»Ÿè®¡** | åŒ…å«é—®é¢˜ç»Ÿè®¡ã€ç”¨æˆ·å…´è¶£ã€åé¦ˆç»Ÿè®¡ç­‰å¤šç»´åˆ†æ | 4/5 |
| **åˆ›æ–°æ€§** | çŸ¥è¯†å›¾è°±é©±åŠ¨çš„ç›¸å…³é—®é¢˜ç”Ÿæˆ | 5/5 |

## æ”¹è¿›å»ºè®®

1. **æ¨èç²¾åº¦æå‡**ï¼šå¢åŠ è¯­ä¹‰ç›¸ä¼¼åº¦è®¡ç®—ï¼Œæé«˜ç›¸å…³é—®é¢˜æ¨èå‡†ç¡®æ€§
2. **å†·å¯åŠ¨é—®é¢˜**ï¼šä¸ºæ–°ç”¨æˆ·æä¾›æ›´æœ‰é’ˆå¯¹æ€§çš„åˆå§‹æ¨è
3. **åé¦ˆåˆ©ç”¨**ï¼šåˆ©ç”¨åé¦ˆæ•°æ®ä¼˜åŒ–æ¨èç®—æ³•æƒé‡
4. **ç¼“å­˜æœºåˆ¶**ï¼šä¸ºçƒ­é—¨é—®é¢˜æ·»åŠ æ¨èç¼“å­˜ï¼Œæé«˜ç³»ç»Ÿå“åº”é€Ÿåº¦

## æ€»ç»“

æ™ºèƒ½æ¨èç³»ç»ŸæˆåŠŸå®ç°äº†åŸºäºç”¨æˆ·è¡Œä¸ºã€çŸ¥è¯†å›¾è°±å’Œçƒ­ç‚¹ç»Ÿè®¡çš„å¤šç­–ç•¥æ¨èåŠŸèƒ½ã€‚ç³»ç»Ÿèƒ½æœ‰æ•ˆæ•æ‰ç”¨æˆ·å…´è¶£ç‰¹å¾ï¼Œæä¾›ä¸ªæ€§åŒ–é—®é¢˜æ¨èï¼Œå¹¶æ”¶é›†åé¦ˆç”¨äºæŒç»­ä¼˜åŒ–ã€‚

æµ‹è¯•ç»“æœè¡¨æ˜ï¼Œè¯¥æ¨¡å—ç¬¦åˆç¬¬äº”å‘¨ä»»åŠ¡è¦æ±‚ï¼Œå®ç°äº†é¢„æœŸåŠŸèƒ½ï¼Œæ€§èƒ½è‰¯å¥½ï¼Œç‰¹åˆ«æ˜¯åœ¨è½»é‡åŒ–å®ç°å’Œåˆ›æ–°æ€§æ–¹é¢ç¬¦åˆè·å¥–æ ‡å‡†çš„è¦æ±‚ã€‚

"""
    
    # å†™å…¥æŠ¥å‘Šæ–‡ä»¶
    with open(report_path, 'w', encoding='utf-8') as f:
        f.write(report_content)
    
    print(f"\nâœ… æµ‹è¯•æŠ¥å‘Šå·²ç”Ÿæˆ: {report_path}")
    return report_path

if __name__ == "__main__":
    main() 